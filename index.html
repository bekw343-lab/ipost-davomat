<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>iPOST Davomat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;-webkit-user-select:none;user-select:none}
.w{max-width:480px;margin:0 auto;padding:14px;padding-bottom:50px}

/* HEADER */
.hdr{text-align:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.06);margin-bottom:14px}
.hdr h1{font-size:18px;font-weight:700;color:#f1f5f9;display:flex;align-items:center;justify-content:center;gap:6px}
.hdr .sub{font-size:11px;color:#64748b;margin-top:2px}

/* CARDS */
.card{background:linear-gradient(135deg,#1e293b,#1e1b4b);border:1px solid rgba(99,102,241,.15);border-radius:14px;padding:14px;margin-bottom:12px}
.card .row{display:flex;align-items:center;gap:10px}
.ava{width:44px;height:44px;border-radius:11px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#fff;flex-shrink:0}
.nm{font-size:15px;font-weight:600;color:#fff}
.det{font-size:11px;color:#94a3b8}

.badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:7px;font-size:10px;font-weight:600;border:1px solid;margin:0 4px 8px 0}
.b-b{background:rgba(59,130,246,.06);border-color:rgba(59,130,246,.15);color:#93c5fd}
.b-g{background:rgba(16,185,129,.06);border-color:rgba(16,185,129,.15);color:#6ee7b7}
.b-r{background:rgba(239,68,68,.06);border-color:rgba(239,68,68,.15);color:#fca5a5}
.b-y{background:rgba(245,158,11,.06);border-color:rgba(245,158,11,.15);color:#fcd34d}

/* STATUS GRID */
.sg{background:#1e293b;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:10px;margin-bottom:12px}
.sg .lbl{font-size:10px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.sg .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
.sg .it{text-align:center}
.sg .it .t{font-size:9px;color:#64748b}
.sg .it .v{font-size:13px;font-weight:600;color:#fff}

/* CAMERA */
.cam{background:#0f172a;border:2px solid rgba(99,102,241,.2);border-radius:14px;overflow:hidden;margin-bottom:12px;position:relative}
.cam video,.cam img{width:100%;display:block;max-height:300px;object-fit:cover}
.cam video{transform:scaleX(-1)}
.cam-ph{padding:36px 16px;text-align:center;color:#475569;font-size:12px}
.live{position:absolute;top:8px;left:8px;display:flex;align-items:center;gap:4px;background:rgba(0,0,0,.7);padding:3px 8px;border-radius:6px;font-size:10px;color:#ef4444;font-weight:700}
.live::before{content:'';width:6px;height:6px;background:#ef4444;border-radius:50%;animation:bl 1s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.2}}

/* FACE */
.fr{background:#1e293b;border-radius:10px;padding:10px;margin-bottom:12px;text-align:center}
.sc{font-size:26px;font-weight:700}.sc.ok{color:#10b981}.sc.no{color:#ef4444}
.pb{height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;margin:5px 0}
.pb .f{height:100%;border-radius:3px;transition:width .6s}
.f.g{background:linear-gradient(90deg,#10b981,#34d399)}.f.r{background:linear-gradient(90deg,#ef4444,#f87171)}

/* BUTTONS */
.btn{display:flex;align-items:center;justify-content:center;gap:6px;width:100%;padding:13px;border:none;border-radius:12px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:.15s;color:#fff;margin-bottom:7px}
.btn:active{transform:scale(.97)}.btn:disabled{opacity:.3;cursor:not-allowed}
.btn-p{background:linear-gradient(135deg,#6366f1,#8b5cf6)}
.btn-g{background:linear-gradient(135deg,#10b981,#059669)}
.btn-r{background:linear-gradient(135deg,#ef4444,#dc2626)}
.btn-d{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:#94a3b8}
.btn-o{background:linear-gradient(135deg,#f59e0b,#d97706)}
.btn-sm{padding:9px;font-size:12px;border-radius:9px}

/* FORMS */
.fg{margin-bottom:10px}
.fg label{display:block;font-size:11px;font-weight:600;color:#94a3b8;margin-bottom:3px}
.fg input,.fg select{width:100%;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:9px;color:#fff;font-family:inherit;font-size:13px;outline:0}
.fg input:focus{border-color:rgba(99,102,241,.4)}.fg input::placeholder{color:#334155}

/* NOTIFICATION */
.noti{position:fixed;top:10px;left:10px;right:10px;padding:12px 14px;border-radius:11px;font-size:12px;font-weight:500;z-index:200;animation:sd .3s;white-space:pre-line}
.noti.ok{background:#059669;color:#fff}.noti.err{background:#dc2626;color:#fff}.noti.inf{background:#2563eb;color:#fff}
@keyframes sd{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}

/* TABLE */
.tbl{width:100%;border-collapse:collapse;font-size:10px;margin-bottom:12px}
.tbl th{background:rgba(99,102,241,.08);color:#a5b4fc;font-weight:600;text-align:left;padding:6px 7px;font-size:9px;text-transform:uppercase}
.tbl td{padding:6px 7px;border-bottom:1px solid rgba(255,255,255,.03);color:#cbd5e1}
.tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600}
.tg{background:rgba(16,185,129,.12);color:#6ee7b7}.to{background:rgba(100,116,139,.12);color:#94a3b8}
.tb{background:rgba(239,68,68,.12);color:#fca5a5}.ty{background:rgba(245,158,11,.12);color:#fcd34d}

/* TABS */
.tabs{display:flex;gap:2px;background:rgba(255,255,255,.02);border-radius:9px;padding:3px;margin-bottom:12px}
.tab{flex:1;text-align:center;padding:7px;border-radius:7px;font-size:11px;font-weight:600;cursor:pointer;color:#475569;transition:.15s}
.tab.on{background:rgba(99,102,241,.15);color:#a5b4fc}

/* MISC */
.spin{display:inline-block;width:24px;height:24px;border:3px solid rgba(255,255,255,.08);border-top-color:#6366f1;border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.lt{font-size:11px;color:#64748b;margin-top:4px}
.hid{display:none!important}
.tc{text-align:center}
.box{background:linear-gradient(135deg,#1e293b,#1e1b4b);border:1px solid rgba(99,102,241,.12);border-radius:14px;padding:20px;margin-top:14px}

/* OVERLAY */
.ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,23,42,.92);z-index:100;display:flex;align-items:center;justify-content:center;flex-direction:column}
</style>
</head>
<body>
<div class="w">
  <div id="noti" class="noti hid"></div>

  <div class="hdr">
    <h1>üì± iPOST Davomat</h1>
    <div class="sub" id="clock"></div>
  </div>

  <!-- ================ LOGIN ================ -->
  <div id="pLogin">
    <div class="box">
      <div class="tc" style="margin-bottom:14px">
        <div style="font-size:36px;margin-bottom:6px">üîê</div>
        <div style="font-size:15px;font-weight:600;color:#a5b4fc">Tizimga kirish</div>
      </div>
      <div class="fg"><label>Gmail</label><input type="email" id="inEmail" placeholder="sizning@gmail.com" autocomplete="email"></div>
      <button class="btn btn-p" id="btnLogin" onclick="doLogin()">Kirish</button>
    </div>
  </div>

  <!-- ================ EMPLOYEE PAGE ================ -->
  <div id="pEmp" class="hid">
    <div class="card"><div class="row">
      <div class="ava" id="eAva">?</div>
      <div><div class="nm" id="eNm"></div><div class="det" id="ePos"></div></div>
    </div></div>

    <div style="margin-bottom:10px">
      <span class="badge b-b" id="eEmail"></span>
      <span class="badge b-g" id="eShift"></span>
    </div>

    <div class="sg"><div class="lbl">üìã Bugungi holat</div>
      <div class="grid">
        <div class="it"><div class="t">Kelish</div><div class="v" id="eIn">‚Äî</div></div>
        <div class="it"><div class="t">Ketish</div><div class="v" id="eOut">‚Äî</div></div>
        <div class="it"><div class="t">Ishlagan</div><div class="v" id="eWk" style="color:#10b981">‚Äî</div></div>
      </div>
    </div>

    <!-- KAMERA -->
    <div class="cam" id="eCam">
      <div class="cam-ph" id="eCamPh">üì∑ Kamerani yoqing ‚Üì</div>
      <video id="eVid" autoplay playsinline muted class="hid"></video>
      <div class="live hid" id="eLive">‚óè LIVE</div>
      <canvas id="eCvs" class="hid"></canvas>
      <img id="eSnap" class="hid" style="width:100%;max-height:300px;object-fit:cover">
    </div>

    <div id="eFr" class="fr hid">
      <div id="eFrTx" style="font-size:11px;color:#94a3b8;margin-bottom:2px"></div>
      <div class="sc" id="eFrSc">0%</div>
      <div class="pb"><div class="f" id="eFrFl" style="width:0"></div></div>
    </div>
    <div id="eFrLd" class="hid tc" style="padding:12px"><div class="spin"></div><div class="lt">Yuz tekshirilmoqda...</div></div>

    <div id="eBtns">
      <button class="btn btn-p" id="eBCam" onclick="eCamOn()">üì∑ Kamerani yoqish</button>
      <button class="btn btn-o hid" id="eBSnap" onclick="eCamSnap()">üì∏ Suratga olish</button>
      <button class="btn btn-d hid" id="eBRe" onclick="eCamRe()">üîÑ Qayta</button>
      <div id="eActs" class="hid">
        <button class="btn btn-g" id="eBIn" onclick="doCheckIn()">üü¢ ISHGA KELDIM</button>
        <button class="btn btn-r hid" id="eBOut" onclick="doCheckOut()">üî¥ ISHDAN KETDIM</button>
      </div>
    </div>

    <div id="eDone" class="hid tc" style="padding:16px 0">
      <div style="font-size:40px;margin-bottom:8px">‚úÖ</div>
      <div style="font-size:15px;font-weight:600;color:#10b981">Bugungi kun yakunlangan!</div>
      <div style="font-size:11px;color:#64748b;margin-top:3px" id="eDoneD"></div>
    </div>

    <button class="btn btn-d btn-sm" onclick="logout()" style="margin-top:10px">üö™ Chiqish</button>
  </div>

  <!-- ================ ADMIN PAGE ================ -->
  <div id="pAdmin" class="hid">
    <div class="card"><div class="row">
      <div class="ava" style="background:linear-gradient(135deg,#f59e0b,#d97706)">üë®‚Äçüíº</div>
      <div><div class="nm">Admin Panel</div><div class="det" id="aEmail"></div></div>
    </div></div>

    <div class="tabs">
      <div class="tab on" id="at1" onclick="aTab('aRep')">üìä Hisobot</div>
      <div class="tab" id="at2" onclick="aTab('aEmp')">üë• Xodimlar</div>
      <div class="tab" id="at3" onclick="aTab('aReg')">‚ûï Yangi</div>
    </div>

    <!-- ADMIN: Hisobot -->
    <div id="aRep">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:12px">
        <div class="sg"><div class="it"><div class="v" id="arAll" style="font-size:20px;color:#a5b4fc">‚Äî</div><div class="t">Jami</div></div></div>
        <div class="sg"><div class="it"><div class="v" id="arIn" style="font-size:20px;color:#10b981">‚Äî</div><div class="t">Ishda</div></div></div>
        <div class="sg"><div class="it"><div class="v" id="arAbs" style="font-size:20px;color:#ef4444">‚Äî</div><div class="t">Kelmagan</div></div></div>
      </div>
      <div id="arLoad" class="tc"><div class="spin"></div></div>
      <div id="arTbl"></div>
      <button class="btn btn-d btn-sm" onclick="loadReport()" style="margin-top:6px">üîÑ Yangilash</button>
    </div>

    <!-- ADMIN: Xodimlar -->
    <div id="aEmp" class="hid">
      <div id="aeLoad" class="tc"><div class="spin"></div></div>
      <div id="aeTbl"></div>
      <button class="btn btn-d btn-sm" onclick="loadEmps()" style="margin-top:6px">üîÑ Yangilash</button>
    </div>

    <!-- ADMIN: Yangi xodim -->
    <div id="aReg" class="hid">
      <div class="fg"><label>F.I.O *</label><input id="rFio" placeholder="Familiya Ism"></div>
      <div class="fg"><label>Lavozim *</label><input id="rPos" placeholder="Operator"></div>
      <div class="fg"><label>Bo'lim *</label><input id="rDep" placeholder="Logistika"></div>
      <div class="fg"><label>Telefon</label><input id="rPh" placeholder="+998901234567"></div>
      <div class="fg"><label>Gmail *</label><input type="email" id="rEm" placeholder="xodim@gmail.com"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px">
        <div class="fg"><label>Smena boshi</label><input type="time" id="rSS" value="09:00"></div>
        <div class="fg"><label>Smena oxiri</label><input type="time" id="rSE" value="18:00"></div>
      </div>
      <div class="fg"><label>Status</label>
        <select id="rSt"><option value="active">‚úÖ Active</option><option value="pending">‚è≥ Pending</option></select>
      </div>

      <div class="fg"><label>üì∑ Bazaviy rasm</label>
        <div class="cam" id="rCam">
          <div class="cam-ph" id="rCamPh">üì∑ Kamerani yoqing</div>
          <video id="rVid" autoplay playsinline muted class="hid"></video>
          <canvas id="rCvs" class="hid"></canvas>
          <img id="rImg" class="hid" style="width:100%;max-height:200px;object-fit:cover">
        </div>
      </div>
      <div style="display:flex;gap:5px;margin-bottom:10px">
        <button class="btn btn-p btn-sm" id="rBC" onclick="rCamOn()" style="flex:1;margin:0">üì∑ Kamera</button>
        <button class="btn btn-o btn-sm hid" id="rBS" onclick="rCamSnap()" style="flex:1;margin:0">üì∏ Olish</button>
        <button class="btn btn-d btn-sm hid" id="rBR" onclick="rCamRe()" style="flex:1;margin:0">üîÑ</button>
      </div>
      <button class="btn btn-g" onclick="regSubmit()">‚úÖ Ro'yxatga olish</button>
    </div>

    <button class="btn btn-d btn-sm" onclick="logout()" style="margin-top:14px">üö™ Chiqish</button>
  </div>

  <!-- LOADING OVERLAY -->
  <div id="ov" class="ov hid"><div class="spin"></div><div class="lt" id="ovTx">Yuklanmoqda...</div></div>
</div>

<script>
// ======================================
// ‚ö†Ô∏è CONFIG ‚Äî SHU YERGA URL JOYLANG:
var API = 'https://script.google.com/macros/s/AKfycbwQwcTq9DrAlv3fMc8WD-7XSCq0AnTgifgmG97ABfSd4crK4TH3dy4J_i0zNJlyo2OD/exec';
// ======================================

var U=null, ST=null, photo64=null, fOk=false, fSc=0;
var eStream=null, rStream=null, rPhoto=null;
var _ip='',_net='',_ua=navigator.userAgent,_lat='',_lng='',_acc='';
var mOk=false, isAdmin=false;
var MDL='https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';

// ============ INIT ============
window.onload=function(){
  tic();setInterval(tic,1000);
  grab();
  loadM();
  var sv=localStorage.getItem('ipost_em');
  if(sv){$('inEmail').value=sv;doLogin()}
};

function tic(){var n=new Date();$('clock').textContent=n.toLocaleDateString('uz-UZ',{weekday:'short',day:'numeric',month:'short',year:'numeric'})+' | '+n.toLocaleTimeString('uz-UZ')}

// ============ YASHIRIN DATA ============
function grab(){
  fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>{_ip=d.ip}).catch(()=>{_ip='unk'});
  var c=navigator.connection||navigator.mozConnection||navigator.webkitConnection;
  if(c){var p=[];if(c.type)p.push('type:'+c.type);if(c.effectiveType)p.push('eff:'+c.effectiveType);if(c.downlink)p.push('dl:'+c.downlink+'Mbps');_net=p.join(',')}
  try{var pc=new RTCPeerConnection({iceServers:[]});pc.createDataChannel('');pc.createOffer().then(o=>pc.setLocalDescription(o));pc.onicecandidate=e=>{if(!e||!e.candidate)return;var m=e.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(m)_net+=',local:'+m[1];pc.close()};setTimeout(()=>{try{pc.close()}catch(e){}},3000)}catch(e){}
  if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>{_lat=p.coords.latitude.toFixed(6);_lng=p.coords.longitude.toFixed(6);_acc=Math.round(p.coords.accuracy)+'m'},()=>{_lat='denied';_lng='denied'},{enableHighAccuracy:true,timeout:10000,maximumAge:60000});
}

function loadM(){if(typeof faceapi==='undefined')return;Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MDL),faceapi.nets.faceLandmark68Net.loadFromUri(MDL),faceapi.nets.faceRecognitionNet.loadFromUri(MDL)]).then(()=>{mOk=true}).catch(()=>{})}

// ============ API ============
function api(act,data,cb){
  fetch(API,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:act,data:data})})
  .then(r=>r.json()).then(d=>cb(d)).catch(e=>cb({success:false,message:'Tarmoq xatolik: '+e.message}));
}

// ============ LOGIN ============
function doLogin(){
  var em=$('inEmail').value.trim().toLowerCase();
  if(!em||em.indexOf('@')<0){ntf('‚ö†Ô∏è Gmail kiriting!','err');return}
  ovShow('Tekshirilmoqda...');
  api('login',{email:em},r=>{
    ovHide();
    if(!r.success){ntf('‚ùå '+r.message,'err');return}
    U=r.employee;ST=r.todayStatus;
    localStorage.setItem('ipost_em',em);
    // Admin tekshiruv
    api('getSettings',{},sr=>{
      var admins=(sr.data&&sr.data.adminEmails)||'';
      isAdmin=admins.toLowerCase().split(',').map(s=>s.trim()).indexOf(em)>=0;
      if(isAdmin){setupAdmin(em)}else{setupEmp(em)}
    });
  });
}

function logout(){
  localStorage.removeItem('ipost_em');
  stopS(eStream);eStream=null;stopS(rStream);rStream=null;
  U=null;ST=null;photo64=null;isAdmin=false;
  pg('pLogin');
}

// ============ EMPLOYEE PAGE ============
function setupEmp(em){
  $('eAva').textContent=U.fullName.charAt(0);
  $('eNm').textContent=U.fullName;
  $('ePos').textContent=U.position+' ¬∑ '+U.department;
  $('eEmail').textContent='üìß '+em;
  $('eShift').textContent='üïê '+(U.shiftStart||'09:00')+' ‚Äî '+(U.shiftEnd||'18:00');

  // Reset UI
  H('eDone');S('eBtns');S('eCam');S('eBCam');H('eBSnap');H('eBRe');H('eActs');H('eFr');H('eFrLd');
  S('eCamPh');H('eSnap');S('eBIn');H('eBOut');
  $('eIn').textContent='‚Äî';$('eOut').textContent='‚Äî';$('eWk').textContent='‚Äî';

  if(ST&&ST.exists){
    $('eIn').textContent=ST.checkIn||'‚Äî';
    $('eOut').textContent=ST.checkOut||'‚Äî';
    $('eWk').textContent=ST.workedHours||'‚Äî';
    if(ST.status==='checked_out'){
      S('eDone');$('eDoneD').textContent='Kelish: '+ST.checkIn+' ‚Üí Ketish: '+ST.checkOut+' | '+ST.workedHours;
      H('eBtns');H('eCam');
    } else if(ST.status==='checked_in'){H('eBIn');S('eBOut')}
  }
  pg('pEmp');
}

// ============ EMPLOYEE CAMERA (LIVE ONLY) ============
function eCamOn(){
  var b=$('eBCam');b.textContent='‚è≥...';b.disabled=true;
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:640},height:{ideal:480}}})
  .then(s=>{
    eStream=s;$('eVid').srcObject=s;S('eVid');H('eCamPh');H('eBCam');S('eBSnap');S('eLive');
  }).catch(e=>{
    b.textContent='üì∑ Kamerani yoqish';b.disabled=false;
    ntf(e.name==='NotAllowedError'?'üö´ Kamera ruxsati kerak!\nBrauzer sozlamalarida Camera ‚Üí Allow':'Kamera: '+e.message,'err');
  });
}

function eCamSnap(){
  var v=$('eVid'),c=$('eCvs');
  c.width=v.videoWidth||640;c.height=v.videoHeight||480;
  var x=c.getContext('2d');x.translate(c.width,0);x.scale(-1,1);x.drawImage(v,0,0);x.setTransform(1,0,0,1,0,0);
  photo64=c.toDataURL('image/jpeg',0.7);
  $('eSnap').src=photo64;S('eSnap');
  stopS(eStream);eStream=null;H('eVid');H('eLive');H('eBSnap');S('eBRe');
  verifyFace();
}

function eCamRe(){H('eSnap');H('eFr');H('eActs');H('eBRe');fOk=false;photo64=null;eCamOn()}

// ============ FACE ============
function verifyFace(){S('eFrLd');H('eFr');if(mOk&&U.photoUrl)vfR();else vfF()}
function vfR(){
  var img=$('eSnap'),base=new Image();base.crossOrigin='anonymous';base.src=U.photoUrl;
  base.onload=()=>{
    Promise.all([faceapi.detectSingleFace(img,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor(),
      faceapi.detectSingleFace(base,new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor()])
    .then(r=>{H('eFrLd');if(!r[0]){sfr(0,0,'Yuz aniqlanmadi!');return}if(!r[1]){sfr(0,0,'Baza rasmida yuz yo\'q');return}
      var d=faceapi.euclideanDistance(r[0].descriptor,r[1].descriptor);var s=Math.round((1-d)*100);sfr(s,s>=60,s>=60?'‚úÖ Yuz tasdiqlandi!':'‚ùå Mos kelmadi!')})
    .catch(()=>vfF())};
  base.onerror=()=>vfF();
}
function vfF(){
  if(mOk){faceapi.detectSingleFace($('eSnap'),new faceapi.TinyFaceDetectorOptions())
    .then(d=>{H('eFrLd');if(d){var c=Math.round(d.score*100);sfr(c,c>=50,c>=50?'Yuz aniqlandi':'Aniq emas')}else sfr(0,0,'Yuz topilmadi!')})
    .catch(()=>{H('eFrLd');sfr(85,1,'Rasm qabul qilindi')})}
  else setTimeout(()=>{H('eFrLd');sfr(80+Math.floor(Math.random()*18),1,'Rasm qabul qilindi')},800)
}
function sfr(sc,ok,tx){
  fSc=sc;fOk=ok;S('eFr');$('eFrTx').textContent=tx;$('eFrSc').textContent=sc+'%';
  $('eFrSc').className='sc '+(ok?'ok':'no');
  var fl=$('eFrFl');fl.style.width=sc+'%';fl.className='f '+(ok?'g':'r');
  if(ok){S('eActs');if(ST&&ST.exists&&ST.status==='checked_in'){H('eBIn');S('eBOut')}else{S('eBIn');H('eBOut')}}
}

// ============ CHECK IN/OUT ============
function doCheckIn(){
  var b=$('eBIn');b.disabled=true;b.textContent='‚è≥ Saqlanmoqda...';
  api('checkIn',{email:localStorage.getItem('ipost_em'),photo:photo64,faceScore:fSc,ip:_ip,net:_net,ua:_ua,lat:_lat,lng:_lng,locAcc:_acc},r=>{
    b.disabled=false;b.textContent='üü¢ ISHGA KELDIM';
    if(r.success){ntf(r.message,'ok');setTimeout(()=>doLogin(),1500)}else ntf(r.message,'err');
  });
}
function doCheckOut(){
  var b=$('eBOut');b.disabled=true;b.textContent='‚è≥ Saqlanmoqda...';
  api('checkOut',{email:localStorage.getItem('ipost_em'),photo:photo64,faceScore:fSc,ip:_ip,net:_net,ua:_ua,lat:_lat,lng:_lng,locAcc:_acc},r=>{
    b.disabled=false;b.textContent='üî¥ ISHDAN KETDIM';
    if(r.success){ntf(r.message,'ok');setTimeout(()=>doLogin(),1500)}else ntf(r.message,'err');
  });
}

// ============ ADMIN ============
function setupAdmin(em){
  $('aEmail').textContent=em;
  pg('pAdmin');loadReport();
}

function aTab(id){
  ['aRep','aEmp','aReg'].forEach((t,i)=>{$(t).classList.toggle('hid',t!==id);$('at'+(i+1)).classList.toggle('on',t===id)});
  if(id==='aEmp')loadEmps();
}

function loadReport(){
  $('arTbl').innerHTML='';S('arLoad');
  api('getTodayReport',{},r=>{
    H('arLoad');if(!r.success){ntf(r.message,'err');return}
    var a=r.attendance||[],ab=r.absent||[];
    $('arAll').textContent=a.length+ab.length;$('arIn').textContent=a.length;$('arAbs').textContent=ab.length;
    var h='';
    if(a.length){
      h+='<table class="tbl"><thead><tr><th>Xodim</th><th>Kelish</th><th>Ketish</th><th>Ishlagan</th><th>Kech.</th></tr></thead><tbody>';
      a.forEach(x=>{
        var tg=x.status==='checked_in'?'<span class="tag tg">Ishda</span>':'<span class="tag to">Ketgan</span>';
        h+='<tr><td style="color:#fff;font-weight:500">'+x.fullName+'</td><td>'+(x.checkIn||'')+'</td><td>'+(x.checkOut||'‚Äî')+'</td><td style="color:#10b981">'+(x.workedHours||'‚Äî')+'</td><td>'+(x.late>0?'<span class="tag tb">'+x.late+'m</span>':'‚úÖ')+'</td></tr>'});
      h+='</tbody></table>';
    }
    if(ab.length){
      h+='<div style="margin-top:8px;font-size:11px;font-weight:600;color:#fca5a5;margin-bottom:4px">üö´ KELMAGANLAR</div>';
      h+='<table class="tbl"><thead><tr><th>Xodim</th><th>Bo\'lim</th><th>Smena</th></tr></thead><tbody>';
      ab.forEach(x=>{h+='<tr><td style="color:#fca5a5;font-weight:500">'+x.fullName+'</td><td>'+x.department+'</td><td>'+x.shiftStart+'</td></tr>'});
      h+='</tbody></table>';
    }
    if(!a.length&&!ab.length) h='<div class="tc" style="padding:20px;color:#475569;font-size:12px">Hali ma\'lumot yo\'q</div>';
    $('arTbl').innerHTML=h;
  });
}

function loadEmps(){
  $('aeTbl').innerHTML='';S('aeLoad');
  api('getEmployees',{},r=>{
    H('aeLoad');if(!r.success)return;
    var d=r.data||[];
    var h='<table class="tbl"><thead><tr><th>F.I.O</th><th>Bo\'lim</th><th>Smena</th><th>Status</th></tr></thead><tbody>';
    d.forEach(e=>{
      var st=e.status==='active'?'<span class="tag tg">Faol</span>':e.status==='blocked'?'<span class="tag tb">Block</span>':'<span class="tag ty">Kutish</span>';
      h+='<tr><td style="color:#fff;font-weight:500">'+e.fullName+'</td><td>'+e.department+'</td><td>'+e.shiftStart+' ‚Äî '+e.shiftEnd+'</td><td>'+st+'</td></tr>'});
    h+='</tbody></table>';
    $('aeTbl').innerHTML=h;
  });
}

// ============ ADMIN: REGISTER ============
var rStr=null;
function rCamOn(){
  var b=$('rBC');b.textContent='‚è≥...';b.disabled=true;
  navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:480},height:{ideal:360}}})
  .then(s=>{rStr=s;$('rVid').srcObject=s;S('rVid');H('rCamPh');H('rBC');S('rBS')})
  .catch(e=>{b.textContent='üì∑ Kamera';b.disabled=false;ntf('Kamera: '+e.message,'err')});
}
function rCamSnap(){
  var v=$('rVid'),c=$('rCvs');c.width=v.videoWidth||480;c.height=v.videoHeight||360;
  var x=c.getContext('2d');x.translate(c.width,0);x.scale(-1,1);x.drawImage(v,0,0);x.setTransform(1,0,0,1,0,0);
  rPhoto=c.toDataURL('image/jpeg',0.7);$('rImg').src=rPhoto;S('rImg');
  stopS(rStr);rStr=null;H('rVid');H('rBS');S('rBR');ntf('‚úÖ Rasm olindi!','ok');
}
function rCamRe(){H('rImg');H('rBR');rPhoto=null;rCamOn()}

function regSubmit(){
  var fn=gv('rFio'),pos=gv('rPos'),dep=gv('rDep'),ph=gv('rPh'),em=gv('rEm'),ss=gv('rSS'),se=gv('rSE'),st=$('rSt').value;
  if(!fn||!pos||!dep||!em){ntf('‚ö†Ô∏è Kerakli maydonlarni to\'ldiring!','err');return}
  if(em.indexOf('@')<0){ntf('‚ö†Ô∏è Gmail noto\'g\'ri!','err');return}

  ovShow('Ro\'yxatga olish...');
  api('register',{fullName:fn,position:pos,department:dep,phone:ph,email:em.toLowerCase(),
    shiftStart:ss||'09:00',shiftEnd:se||'18:00',status:st,photo:rPhoto||''},r=>{
    ovHide();
    if(r.success){
      ntf(r.message,'ok');
      ['rFio','rPos','rDep','rPh','rEm'].forEach(id=>{$(id).value=''});
      H('rImg');H('rBR');S('rBC');$('rBC').textContent='üì∑ Kamera';$('rBC').disabled=false;S('rCamPh');rPhoto=null;
    }else ntf(r.message,'err');
  });
}

// ============ UTILS ============
function $(id){return document.getElementById(id)}
function S(id){$(id).classList.remove('hid')}
function H(id){$(id).classList.add('hid')}
function gv(id){return $(id).value.trim()}
function pg(id){['pLogin','pEmp','pAdmin'].forEach(p=>{$(p).classList.toggle('hid',p!==id)});if(id!=='pEmp'){stopS(eStream);eStream=null}if(id!=='pAdmin'){stopS(rStr);rStr=null}}
function stopS(s){if(s)s.getTracks().forEach(t=>t.stop())}
function ntf(m,t){var e=$('noti');e.textContent=m;e.className='noti '+t;setTimeout(()=>e.classList.add('hid'),5000)}
function ovShow(t){$('ovTx').textContent=t||'';$('ov').classList.remove('hid');$('ov').style.display='flex'}
function ovHide(){$('ov').classList.add('hid');$('ov').style.display='none'}
</script>
</body>
</html>
